<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¶åº­ç›‘æ§ V5.0 (ä½ç ç‡ç¨³å®šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .container { text-align: center; width: 90%; max-width: 600px; }
        
        /* çŠ¶æ€æ å¢å¼º */
        #status-bar { 
            background: #222; padding: 12px; border-radius: 8px; margin-bottom: 20px; 
            border: 1px solid #444; color: #aaa; font-size: 14px; 
            white-space: pre-wrap; /* å…è®¸æ¢è¡Œæ˜¾ç¤ºæ—¥å¿— */
        }
        .error { color: #ff5252 !important; border-color: #ff5252 !important; }
        .success { color: #4caf50 !important; border-color: #4caf50 !important; }
        .warn { color: #ff9800 !important; border-color: #ff9800 !important; }

        /* è§†é¢‘åŒºåŸŸ */
        video { width: 100%; background: #111; border-radius: 10px; border: 1px solid #333; max-height: 60vh; display: none; }

        /* æŒ‰é’®ä¸è¾“å…¥ */
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; }
        .btn-cam { background: #2196F3; }
        .btn-view { background: #ff9800; }
        input { padding: 15px; width: 60%; border-radius: 8px; border: none; outline: none; margin-right: 5px; font-size: 16px; }

        .id-text { font-size: 20px; color: #2196F3; font-weight: bold; letter-spacing: 1px; margin: 10px 0; user-select: all; background: #222; padding: 10px; border-radius: 5px;}
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="status-bar">ç³»ç»Ÿå‡†å¤‡å°±ç»ª (V5.0)</div>
    </div>

    <div id="menu" class="container">
        <button class="btn btn-cam" onclick="startCameraMode()">ğŸ’» ç”µè„‘ç«¯ (å‘é€ç«¯)</button>
        <button class="btn btn-view" onclick="startViewMode()">ğŸ“± æ‰‹æœºç«¯ (æ¥æ”¶ç«¯)</button>
        <p style="font-size:12px; color:#666">å»ºè®®ç”µè„‘è¿æ¥ Wi-Fiï¼Œæ‰‹æœºå°½é‡ä¿¡å·æ»¡æ ¼</p>
    </div>

    <div id="camera-ui" class="container hidden">
        <p>ç”µè„‘ ID:</p>
        <div class="id-text" id="my-id">...</div>
        <p style="font-size:12px; color:#aaa">æ­£åœ¨å‘é€ 361P ä½å»¶è¿Ÿç”»é¢...</p>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div id="view-ui" class="container hidden">
        <div style="display:flex; justify-content:center;">
            <input type="text" id="target-id" placeholder="è¾“å…¥ç”µè„‘ID">
            <button class="btn btn-view" style="width:35%; margin:0" onclick="connectToCamera()">è¿æ¥</button>
        </div>
        <video id="remoteVideo" autoplay playsinline controls></video>
    </div>

    <script>
        // é…ç½®ï¼šç»§ç»­ä½¿ç”¨ Google STUNï¼Œä½†å¢åŠ è¶…æ—¶è®¾ç½®
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            },
            debug: 1
        };

        const peer = new Peer(peerConfig);
        let localStream = null;
        let activeCall = null;
        let keepAliveInterval = null;

        const statusEl = document.getElementById('status-bar');

        function log(msg, type = 'normal') {
            statusEl.innerText = msg;
            statusEl.className = type;
            console.log(msg);
        }

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            log("âœ… IDå·²ç”Ÿæˆï¼Œè¯·é€‰æ‹©æ¨¡å¼", "success");
        });

        peer.on('error', (err) => {
            log("âŒ é”™è¯¯: " + err.type, "error");
        });

        // --- ç”µè„‘ç«¯é€»è¾‘ (é™è´¨ä¿ç¨³) ---
        async function startCameraMode() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('camera-ui').classList.remove('hidden');
            log("æ­£åœ¨å¯åŠ¨ä½å¸¦å®½æ¨¡å¼æ‘„åƒå¤´...");

            try {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¼ºåˆ¶ä½¿ç”¨ 360P å’Œ 15å¸§ï¼Œå¤§å¹…é™ä½å¸¦å®½å‹åŠ›
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720, frameRate: 30 }, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').style.display = 'block';
                log("ğŸ¥ æ‘„åƒå¤´å°±ç»ª (360Pæµç•…æ¨¡å¼)\nç­‰å¾…æ‰‹æœºè¿æ¥...", "success");

                peer.on('call', (call) => {
                    log("ğŸ“² æ‰‹æœºæ­£åœ¨æ¥å…¥...", "warn");
                    activeCall = call;
                    
                    // æ¥å¬å¹¶å‘é€æµ
                    call.answer(localStream);
                    
                    // ç›‘å¬è¿æ¥æ–­å¼€
                    call.on('close', () => log("âš ï¸ æ‰‹æœºå·²æ–­å¼€è¿æ¥", "error"));
                    call.on('error', () => log("âš ï¸ è¿æ¥å‘ç”Ÿé”™è¯¯", "error"));
                });

            } catch (err) {
                log("æ— æ³•å¯åŠ¨æ‘„åƒå¤´: " + err.name, "error");
            }
        }

        // --- æ‰‹æœºç«¯é€»è¾‘ ---
        function startViewMode() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('view-ui').classList.remove('hidden');
            log("è¯·è¾“å…¥ç”µè„‘ID");
        }

        function connectToCamera() {
            const targetId = document.getElementById('target-id').value.trim();
            if (!targetId) return alert("è¯·è¾“å…¥ID");

            log("ğŸ”„ æ­£åœ¨ç©¿é€... (è¯·ä¿æŒå±å¹•å¸¸äº®)");

            // å‘é€å‡æµ
            const canvas = document.createElement("canvas");
            canvas.width = 1; canvas.height = 1;
            const fakeStream = canvas.captureStream(10);

            const call = peer.call(targetId, fakeStream);
            activeCall = call;

            call.on('stream', (remoteStream) => {
                log("âœ… ç”»é¢ä¼ è¾“ä¸­ï¼\nå¦‚æœå¡é¡¿æ˜¯æ­£å¸¸çš„ç½‘ç»œç¼“å†²", "success");
                
                const v = document.getElementById('remoteVideo');
                v.style.display = 'block';
                v.srcObject = remoteStream;
                
                // å¼ºåˆ¶æ’­æ”¾
                v.play().catch(e => {
                    log("âš ï¸ è¯·ç‚¹å‡»ä¸€ä¸‹è§†é¢‘ç”»é¢ä»¥æ’­æ”¾å£°éŸ³", "warn");
                });

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¯åŠ¨å¿ƒè·³ä¿æ´»
                startKeepAlive(call);
            });

            call.on('close', () => {
                log("âŒ è¿æ¥å·²æ–­å¼€ (å¯¹æ–¹ç¦»çº¿æˆ–ç½‘ç»œä¸­æ–­)", "error");
                stopKeepAlive();
            });

            call.on('error', (err) => {
                log("âŒ è¿æ¥é”™è¯¯: " + err, "error");
            });
        }

        // --- å¿ƒè·³ä¿æ´»é€»è¾‘ ---
        // æŸäº›è·¯ç”±å™¨å¦‚æœå‘ç°æ²¡æ•°æ®ä¸Šä¼ ï¼Œä¼šåˆ‡æ–­ä¸‹è½½ã€‚
        // æˆ‘ä»¬æ¯ç§’é’Ÿåœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹ï¼Œè™½ç„¶ä¸èƒ½ç›´æ¥å‘åŒ…ï¼Œä½†èƒ½ä¿æŒJSæ´»è·ƒã€‚
        function startKeepAlive(call) {
            if (keepAliveInterval) clearInterval(keepAliveInterval);
            keepAliveInterval = setInterval(() => {
                if (call && call.open) {
                    console.log("Ping... (Keeping connection alive)");
                }
            }, 2000);
        }

        function stopKeepAlive() {
            if (keepAliveInterval) clearInterval(keepAliveInterval);
        }

        // é¡µé¢å…³é—­è­¦å‘Š
        window.onbeforeunload = function() {
            if (activeCall) activeCall.close();
        };
    </script>
</body>
</html>